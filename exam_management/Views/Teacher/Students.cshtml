@model List<ExamManagement.Models.User>
@{
    var editData = ViewBag.EditStudentData as dynamic;
}

<h2>Student Management (My Classes)</h2>

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">@TempData["Error"]</div>
}
@if (TempData["Message"] != null)
{
    <div class="alert alert-success">@TempData["Message"]</div>
}

@{
    var searchDisplay = ViewBag.Search as string ?? "";
    var searchValue = ViewBag.Search as string ?? "";
}
@if (!string.IsNullOrEmpty(ViewBag.Search))
{
    <div class="alert alert-info">
        <strong>Search results for:</strong> @Html.Raw(searchDisplay)
    </div>
}

<div class="row mb-3">
    <div class="col-md-6">
        <form method="get" class="d-flex">
            <input type="text" name="search" class="form-control me-2" placeholder="Search students..." value="@Html.Raw(searchValue)" data-val="false">
            <button type="submit" class="btn btn-outline-primary">Search</button>
        </form>
        @if (!string.IsNullOrEmpty(searchValue))
        {
            <small class="text-muted" title="@Html.Raw(searchValue)">Showing results</small>
        }
    </div>
    <div class="col-md-6 text-end">
        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createStudentModal">
            Add Student
        </button>
    </div>
</div>

<table class="table table-bordered table-striped">
    <thead>
        <tr>
            <th>ID</th>
            <th>Username</th>
            <th>Name</th>
            <th>Phone</th>
            <th>Gender</th>
            <th>Classes</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var s in Model)
        {
            <tr data-id="@s.Id" 
                data-username="@s.Username" 
                data-fullname="@s.FullName" 
                data-phone="@s.PhoneNumber" 
                data-address="@s.Address">
                <td>@s.Id</td>
                <td>@s.Username</td>
                <td>@s.FullName</td>
                <td>@s.PhoneNumber</td>
                <td>@s.Gender</td>
                <td>
                    @foreach(var sub in s.UserSubjects) {
                        <span class="badge bg-info text-dark">@sub.Subject.Name</span>
                    }
                </td>
                <td>
                    <button class="btn btn-warning btn-sm" onclick="openEditModal(this)">Edit</button>
                    <form asp-action="DeleteStudent" asp-route-id="@s.Id" method="post" class="d-inline" onsubmit="return confirm('Remove this student?');">
                        <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                    </form>
                </td>
            </tr>
        }
    </tbody>
</table>

<!-- Create Student Modal -->
<div class="modal fade" id="createStudentModal" tabindex="-1" aria-labelledby="createStudentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-action="CreateStudent" method="post">
                <div class="modal-header">
                    <h5 class="modal-title" id="createStudentModalLabel">Add Student</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div asp-validation-summary="All" class="text-danger"></div>
                    <div class="mb-3">
                        <label class="form-label">Username</label>
                        <input name="Username" id="create_Username" class="form-control" value="@(ViewBag.CreateStudentModel?.Username ?? "")" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Password</label>
                        <input name="Password" id="create_Password" type="password" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Full Name</label>
                        <input name="FullName" id="create_FullName" class="form-control" value="@(ViewBag.CreateStudentModel?.FullName ?? "")" required />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Select Classes (Your Subjects)</label>
                        <div class="d-flex flex-wrap">
                            @if(ViewBag.Subjects != null) {
                                var subjects = ViewBag.Subjects as List<ExamManagement.Models.Subject>;
                                var autoCheck = subjects != null && subjects.Count == 1;
                                var selectedSubjectIds = ViewBag.CreateStudentModel?.SubjectIds as List<int> ?? new List<int>();
                                foreach (var sub in subjects)
                                {
                                    var isChecked = selectedSubjectIds.Contains(sub.Id) || (autoCheck && selectedSubjectIds.Count == 0);
                                    <div class="form-check me-3">
                                        <input class="form-check-input" type="checkbox" name="SubjectIds" value="@sub.Id" id="sub_@sub.Id" @(isChecked ? "checked" : "")>
                                        <label class="form-check-label" for="sub_@sub.Id">@sub.Name</label>
                                    </div>
                                }
                            }
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-success">Create</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Student Modal -->
<div class="modal fade" id="editStudentModal" tabindex="-1" aria-labelledby="editStudentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="editStudentForm" method="post">
                <div class="modal-header">
                    <h5 class="modal-title" id="editStudentModalLabel">Edit Student</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div asp-validation-summary="All" class="text-danger"></div>
                    <div class="mb-3">
                        <label class="form-label">Username</label>
                        <input name="Username" id="edit_Username" class="form-control" disabled />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Full Name</label>
                        <input name="FullName" id="edit_FullName" class="form-control" value="@(editData?.FullName ?? "")" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Phone</label>
                        <input name="PhoneNumber" id="edit_PhoneNumber" class="form-control" value="@(editData?.PhoneNumber ?? "")" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Address</label>
                        <input name="Address" id="edit_Address" class="form-control" value="@(editData?.Address ?? "")" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function openEditModal(button) {
        var row = button.closest('tr');
        var id = row.getAttribute('data-id');
        var username = row.getAttribute('data-username');
        var fullname = row.getAttribute('data-fullname');
        var phone = row.getAttribute('data-phone');
        var address = row.getAttribute('data-address');

        document.getElementById('edit_Username').value = username;
        document.getElementById('edit_FullName').value = fullname;
        document.getElementById('edit_PhoneNumber').value = phone;
        document.getElementById('edit_Address').value = address;

        // Set form action dynamically
        var form = document.getElementById('editStudentForm');
        form.action = '/Teacher/Students/Edit/' + id;

        // Open Modal
        var myModal = new bootstrap.Modal(document.getElementById('editStudentModal'));
        myModal.show();
    }

    // Auto-open create modal if there are validation errors
    @if (ViewBag.ShowCreateModal == true)
    {
        <text>
        document.addEventListener('DOMContentLoaded', function() {
            var createModal = new bootstrap.Modal(document.getElementById('createStudentModal'));
            createModal.show();
        });
        </text>
    }

    // Auto-open edit modal if there are validation errors
    @if (ViewBag.ShowEditModal == true && ViewBag.EditStudentId != null)
    {
        <text>
        document.addEventListener('DOMContentLoaded', function() {
            // Set form action
            var form = document.getElementById('editStudentForm');
            form.action = '/Teacher/Students/Edit/@ViewBag.EditStudentId';
            
            // Values are already set in the input fields via ViewBag.EditStudentData
            // Open Modal
            var editModal = new bootstrap.Modal(document.getElementById('editStudentModal'));
            editModal.show();
        });
        </text>
    }
</script>