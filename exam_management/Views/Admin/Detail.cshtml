@model ExamManagement.Models.User
@using System.Security.Claims

<h2>User Details</h2>

<div id="view-mode">
    <div class="mb-3">
        <button class="btn btn-warning" onclick="enableEdit()">Edit</button>
        <a asp-action="Index" class="btn btn-secondary">Back</a>
    </div>

    <dl class="row">
        <dt class="col-sm-2">ID</dt>
        <dd class="col-sm-10">@Model.Id</dd>

        <dt class="col-sm-2">Username</dt>
        <dd class="col-sm-10">@Html.Encode(Model.Username)</dd>

        <dt class="col-sm-2">Role</dt>
        <dd class="col-sm-10">@Model.Role</dd>

        <dt class="col-sm-2">Full Name</dt>
        <dd class="col-sm-10">@Html.Encode(Model.FullName)</dd>
        
        <dt class="col-sm-2">Phone</dt>
        <dd class="col-sm-10">@Html.Encode(Model.PhoneNumber)</dd>
        
        <dt class="col-sm-2">Address</dt>
        <dd class="col-sm-10">@Html.Encode(Model.Address)</dd>
        
        <dt class="col-sm-2">Avatar</dt>
        <dd class="col-sm-10">
            @if(Model.AvatarUrl != null) { <img src="@Model.AvatarUrl" width="100" /> } else { <span>No Avatar</span> }
        </dd>
    </dl>
</div>

<div id="edit-mode" style="display:none;">
    <h3>Edit User</h3>
    <form asp-action="Edit" asp-route-id="@Model.Id" method="post" class="w-50">
        <input type="hidden" name="Id" value="@Model.Id" />
        <div class="mb-3">
            <label class="form-label">Username</label>
            <input name="Username" class="form-control" value="@Model.Username" disabled />
        </div>
        <div class="mb-3">
            <label class="form-label">Full Name</label>
            <input name="FullName" class="form-control" value="@Model.FullName" />
        </div>
        <div class="mb-3">
            <label class="form-label">Phone</label>
            <input name="PhoneNumber" class="form-control" value="@Model.PhoneNumber" />
        </div>
        <div class="mb-3">
            <label class="form-label">Address</label>
            <input name="Address" class="form-control" value="@Model.Address" />
        </div>
        <div class="mb-3">
            <label class="form-label">Role</label>
            @{
                var currentUserIdStr = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
                var isSelf = currentUserIdStr != null && int.Parse(currentUserIdStr) == Model.Id;
            }
            
            @if (isSelf)
            {
                 <select name="Role" class="form-select" disabled>
                    <option value="Admin" selected="@(Model.Role == ExamManagement.Models.UserRole.Admin)">Admin</option>
                    <option value="Teacher" selected="@(Model.Role == ExamManagement.Models.UserRole.Teacher)">Teacher</option>
                    <option value="Student" selected="@(Model.Role == ExamManagement.Models.UserRole.Student)">Student</option>
                </select>
                <input type="hidden" name="Role" value="@Model.Role" />
                <div class="form-text text-warning">You cannot change your own role.</div>
            }
            else
            {
                <select name="Role" class="form-select">
                    <option value="Admin" selected="@(Model.Role == ExamManagement.Models.UserRole.Admin)">Admin</option>
                    <option value="Teacher" selected="@(Model.Role == ExamManagement.Models.UserRole.Teacher)">Teacher</option>
                    <option value="Student" selected="@(Model.Role == ExamManagement.Models.UserRole.Student)">Student</option>
                </select>
            }
        </div>
        <button type="submit" class="btn btn-primary">Save</button>
        <button type="button" class="btn btn-secondary" onclick="cancelEdit()">Cancel</button>
    </form>
</div>

<script>
    function enableEdit() {
        document.getElementById('view-mode').style.display = 'none';
        document.getElementById('edit-mode').style.display = 'block';
    }

    function cancelEdit() {
        document.getElementById('view-mode').style.display = 'block';
        document.getElementById('edit-mode').style.display = 'none';
    }
</script>